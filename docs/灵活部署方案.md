## KubeDoor 1.0 全新架构，全新的灵活部署方案
![KubeDoor1 0 0 drawio](../screenshot/1.0/kubedoor1.0-arch.png)
### 组件说明
#### master端(安装在kubedoor命名空间)
- kubedoor-master: 对接agent，提供api接口
- kubedoor-web: 前端界面，整合nginx
- kubedoor-dash: Grafana
- kubedoor-alarm: 接收alertmanager的告警，执行通知与入库
- kubedoor-collect: 定时任务，调用api采集高峰期资源
#### 基础设施(默认和master端部署在一起)
- alertmanager: 告警路由服务
- vmalert: 告警规则计算与管理，触发告警后通知到alertmanager
- VictoriaMetrics: 时序数据库
- ClickHouse:列式数据库
#### agent端(安装在kubedoor命名空间)
- kubedoor-agent: 对接master，调用K8S API
- vmagent: 替代Prometheus，采集监控指标
- KubeStateMetrics: 获取K8S的指标
- NodeExporter: 获取主机的指标

### 部署方案
#### 0. 下载并进入目录
```
### 【下载helm包】
wget https://StarsL.cn/kubedoor/kubedoor-1.0.0.tgz
tar -zxvf kubedoor-1.0.0.tgz
cd kubedoor
```
#### 1. 全新部署（您的K8S没有部署监控系统）
- **master部署:**

1. 配置文件修改: `values-master.yaml`
  1. **storageClass**：【特别注意】默认的部署方案会把`ClickHouse`(单机版)和`VictoriaMetrics`(单机版)都部署在K8S（kubedoor命名空间）内，这2个服务需要存储，注意要填写正确您K8S的`storageClass`（注意有2处`storageClass`）。
  2. **CK_PASSWORD**：【可保持默认】自动部署`ClickHouse`时会将这个密码设置为default用户的密码。
  3. **external_labels_key**：【可保持默认】这是用于多K8S监控数据，通过远程写方式，写入到同一个时序数据库的场景。使用远程存储时，这个key/value会作为标签增加到每一个指标中，这样通过这个标签就可以区分出指标属于哪个K8S了。注意agent端的`external_labels_key`要和master端的`external_labels_key`保持一致。如果是新安装`VictoriaMetrics`可以使用默认配置的`origin_prometheus`不变。
  4. **vm_single**：【可保持默认】自动部署`Victoria-Metrics-Single`时需要配置的账号密码，存储时长等信息。
  5. **nginx_auth**：【可保持默认】这个是web登录的账号密码信息，是使用的nginx basic认证，默认设置了2个用户，一个用于web登录，一个用于agent与master通讯使用，可以根据需要修改。
  6. **MSG_TYPE/MSG_TOKEN**：【需要修改】master端的通知IM类型和机器人token，主要用于告警的默认通知的群机器人，你也可以在alertmanager配置更详细的通知路由。

2. 完成配置修改后执行检查与安装：
```
# try
helm install kubedoor . --namespace kubedoor --create-namespace --values values-master.yaml --dry-run --debug
# install
helm install kubedoor . --namespace kubedoor --create-namespace --values values-master.yaml
```
3. 访问WebUI：使用K8S节点IP + kubedoor-web的NodePort访问，默认账号密码都是 **`kubedoor`**
4. 告警逻辑说明：`vmalert`从`VictoriaMetrics`读取数据，并进行规则比较后，如果触发了告警就会通知到`alertmanager`，alertmanager收到告警后会路由到`kubedoor-alarm`进行告警通知和入库。即使您的K8S内已经有`alertmanager`也不用担心，KubeDoor的alertmanager会安装在kubedoor命名空间，不会冲突。
- **agent部署:**
1. 配置文件修改: `values-agent.yaml`
    1. **ws**：agent和master是同一个K8S：配置为`ws://kubedoor-master.kubedoor`即可，免认证。如果是跨K8S的情况，请配置为您的kubedoor-web外部可访问的地址端口，并按照例子配置认证信息。
    2. **MSG_TYPE/MSG_TOKEN**：大部分对该K8S的操作会通过该机器人进行通知。（不同的K8S可以配置不同的群机器人）
    3. **OSS_URL**：java服务执行dump、jfr、jstack时会把数据存放到OSS，请填写您的OSS地址。（注意设置允许内网免认证上传）
    4. **external_labels_key**：注意部署到多套K8S时，请保持external_labels_key都相同，并且与kubedoor-master的也相同。
    5. **external_labels_value**：设置为您的K8S的名称。
    6. **remoteWriteUrl**：这是vmagent远程写时序数据库的完整URL。agent和master是同一个K8S：配置为`http://monit:dduF1E3sj@victoria-metrics.kubedoor:8428/api/v1/write`，如果是跨K8S的情况，注意修改`victoria-metrics.kubedoor:8428`为您的Victoria-Metrics外部可访问的地址端口。注意账号密码是mater配置中的`vm_single`的账号密码。
